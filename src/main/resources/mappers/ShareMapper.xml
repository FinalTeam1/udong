<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="ShareMapper">
    <resultMap type="ShaCatDTO" id="shaCatMap">
        <!-- 언더바가 들어가는 쿼리문에 한하여 매핑을 해줘야함 -->
        <id property="catCode" column="cat_code" />
        <result property="catName" column="cat_name" />
    </resultMap>

    <resultMap type="shaItemDTO" id="shaItemMap">
        <id property="itemNo" column="item_no" />
        <result property="itemGroup" column="item_group" />
        <result property="itemCatCode" column="item_cat_code" />
        <result property="title" column="title" />
        <result property="content" column="content" />
        <result property="ownerNo" column="owner_no" />
        <result property="nickName" column="nickname" />
        <result property="level" column="level" />
        <result property="locCode" column="loc_code" />
        <result property="locName" column="eup_myeon_dong_name" />
        <result property="createdAt" column="created_at" />
        <result property="modifiedAt" column="modified_at" />
        <result property="expiryDate" column="expiry_date" />
        <result property="statusCode" column="status_code" />
        <result property="dealCnt" column="deal_cnt" />
        <result property="likeCnt" column="like_cnt" />
        <result property="viewCnt" column="view_cnt" />
        <result property="reqCnt" column="req_cnt" />
        <result property="deletedAt" column="deleted_at" />
        <result property="img" column="saved_name" />
    </resultMap>

    <select id="getShaCat" resultMap="shaCatMap">
        select *
        from sha_cat
        order by
        case
            when cat_code = 'OTH' then 1
            else 0
        end,
        cat_code
    </select>

    <insert id="insertItem" useGeneratedKeys="true" keyColumn="item_no" keyProperty="itemNo">
        insert into sha_items
        <if test="itemGroup == 'rent'">
            (item_group, item_cat_code, title, content, owner_no, loc_code)
            values
            (#{itemGroup}, #{itemCatCode}, #{title}, #{content}, #{ownerNo}, #{locCode})
        </if>
        <if test="itemGroup == 'give'">
            (item_group, item_cat_code, title, content, owner_no, loc_code, expiry_date, status_code)
            values
            (#{itemGroup}, #{itemCatCode}, #{title}, #{content}, #{ownerNo}, #{locCode}, #{expiryDate}, 'GIV')
        </if>

    </insert>

    <insert id="insertImg" >
        insert into attachment
        (type_code, target_no, original_name, saved_name)
        values
        <foreach collection="list" item="img" separator=",">
            (#{img.typeCode}, #{img.targetNo}, #{img.originalName}, #{img.savedName})
        </foreach>
    </insert>

    <select id="rentItemList" resultMap="shaItemMap">
        select a.*, c.saved_name
        from sha_items a
        left join (
        select target_no, saved_name
        from (
        select *,
        row_number() over (partition by target_no order by file_no) as rn
        from attachment
        where type_code = 'rent'
        ) sub
        where rn = 1
        ) c on a.item_no = c.target_no
        where a.loc_code = #{locCode}
        and a.item_group = 'rent'
        and a.deleted_at is null
        order by a.created_at desc
    </select>

    <select id="giveItemList" resultMap="shaItemMap">
        select a.*, c.saved_name
        from sha_items a
        left join (
        select target_no, saved_name
        from (
        select *, row_number() over (partition by target_no order by file_no) as rn
        from attachment
        where type_code = 'give'
        ) sub
        where rn = 1
        ) c on a.item_no = c.target_no
        where a.loc_code = #{locCode}
        and a.item_group = 'give'
        and a.deleted_at is null
        order by a.created_at desc
    </select>

    <select id="getItemDetail" resultMap="shaItemMap">
        select a.*, b.nickname, b.level, c.eup_myeon_dong_name
        from sha_items a
        inner join member b
        on a.owner_no = b.member_no
        inner join location c
        on a.loc_code = c.location_code
        where a.item_no = #{itemNo}
    </select>

    <select id="getItemImgs" resultType="attachmentDTO">
        select *
        from attachment
        where target_no = #{itemNo}
        and type_code = #{itemGroup}
    </select>

    <select id="searchItems" resultMap="shaItemMap">
        select a.*, c.saved_name
        from (
            select b.*,
                    row_number() over (order by b.created_at desc) as rn
            from sha_items b
            <where>
                <if test="locCode != null and locCode != ''">and b.loc_code = #{locCode}</if>
                <if test="group != null and group != ''">and b.item_group = #{group}</if>
                <if test="catCode != null and catCode != ''">and b.item_cat_code = #{catCode}</if>
                <if test="1 == 1">and b.deleted_at is null</if>
                <if test="statusCode != null and statusCode != ''">and b.status_code = #{statusCode}</if>
                <if test="keyword != null and keyword != ''">and (b.title like concat('%', #{keyword}, '%') or b.content like concat('%', #{keyword}, '%')) </if>
            </where>
        ) a
        left join (
            select target_no, saved_name
            from (
                select *,
                    row_number() over (partition by target_no order by file_no) as rn
                from attachment
                where type_code = #{group}
            ) sub
            where rn = 1
        ) c on a.item_no = c.target_no
        where a.rn between #{start} and #{end}
        order by a.rn
    </select>

    <select id="getItemCounts" resultType="Integer">
        select count(*)
        from
        sha_items
        <where>
            <if test="locCode != null and locCode != ''">and loc_code = #{locCode}</if>
            <if test="group != null and group != ''">and item_group = #{group}</if>
            <if test="catCode != null and catCode != ''">and item_cat_code = #{catCode}</if>
            <if test="1 == 1">and deleted_at is null</if>
            <if test="statusCode != null and statusCode != ''">and status_code = #{statusCode}</if>
            <if test="keyword != null and keyword != ''">and (title like concat('%', #{keyword}, '%') or content like concat('%', #{keyword}, '%')) </if>
        </where>
    </select>

</mapper>
