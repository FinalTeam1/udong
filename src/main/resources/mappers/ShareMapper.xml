<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="ShareMapper">
    <resultMap type="ShaCatDTO" id="shaCatMap">
        <!-- 언더바가 들어가는 쿼리문에 한하여 매핑을 해줘야함 -->
        <id property="catCode" column="cat_code" />
        <result property="catName" column="cat_name" />
    </resultMap>

    <resultMap type="shaItemDTO" id="shaItemMap">
        <id property="itemNo" column="item_no" />
        <result property="itemGroup" column="item_group" />
        <result property="itemCatCode" column="item_cat_code" />
        <result property="title" column="title" />
        <result property="content" column="content" />
        <result property="ownerNo" column="owner_no" />
        <result property="nickName" column="nickname" />
        <result property="level" column="level" />
        <result property="locCode" column="loc_code" />
        <result property="locName" column="eup_myeon_dong_name" />
        <result property="createdAt" column="created_at" />
        <result property="modifiedAt" column="modified_at" />
        <result property="expiryDate" column="expiry_date" />
        <result property="statusCode" column="status_code" />
        <result property="statusName" column="status_name" />
        <result property="dealCnt" column="deal_cnt" />
        <result property="likeCnt" column="like_cnt" />
        <result property="viewCnt" column="view_cnt" />
        <result property="reqCnt" column="req_cnt" />
        <result property="deletedAt" column="deleted_at" />
        <result property="img" column="saved_name" />
    </resultMap>

    <resultMap id="shaReqMap" type="shaReqDTO">
        <id property="reqNo" column="req_no"/>
        <result property="reqItem" column="req_item" />
        <result property="ownerNo" column="owner_no" />
        <result property="rqstNo" column="rqst_no" />
        <result property="rqstNickname" column="nickname" />
        <result property="createdAt" column="created_at" />
        <result property="modifiedAt" column="modified_at" />
        <result property="returnDate" column="return_date" />
        <result property="statusCode" column="status_code" />
        <result property="statusName" column="status_name" />
        <association property="itemDTO" javaType="shaItemDTO" resultMap="shaItemMap"/>
    </resultMap>

    <select id="getShaCat" resultMap="shaCatMap">
        select *
        from sha_cat
        order by
        case
        when cat_code = 'OTH' then 1
        else 0
        end,
        cat_code
    </select>

    <insert id="insertItem" useGeneratedKeys="true" keyColumn="item_no" keyProperty="itemNo">
        insert into sha_items
        <choose>
            <when test="itemGroup == 'rent'">
                (item_group, item_cat_code, title, content, owner_no, loc_code)
                values
                (#{itemGroup}, #{itemCatCode}, #{title}, #{content}, #{ownerNo}, #{locCode})
            </when>
            <otherwise>
                (item_group, item_cat_code, title, content, owner_no, loc_code, expiry_date, status_code)
                values
                (#{itemGroup}, #{itemCatCode}, #{title}, #{content}, #{ownerNo}, #{locCode}, #{expiryDate}, 'GIV')
            </otherwise>
        </choose>
    </insert>

    <insert id="insertImg" >
        insert into attachment
        (type_code, target_no, original_name, saved_name)
        values
        <foreach collection="list" item="img" separator=",">
            (#{img.typeCode}, #{img.targetNo}, #{img.originalName}, #{img.savedName})
        </foreach>
    </insert>

    <select id="rentItemList" resultMap="shaItemMap">
        select a.*, c.saved_name
        from sha_items a
        left join (
        select target_no, saved_name
        from (
        select *,
        row_number() over (partition by target_no order by file_no) as rn
        from attachment
        where type_code = 'rent'
        ) sub
        where rn = 1
        ) c on a.item_no = c.target_no
        where a.loc_code = #{locCode}
        and a.item_group = 'rent'
        and a.deleted_at is null
        order by a.created_at desc
    </select>

    <select id="giveItemList" resultMap="shaItemMap">
        select a.*, c.saved_name
        from sha_items a
        left join (
        select target_no, saved_name
        from (
        select *, row_number() over (partition by target_no order by file_no) as rn
        from attachment
        where type_code = 'give'
        ) sub
        where rn = 1
        ) c on a.item_no = c.target_no
        where a.loc_code = #{locCode}
        and a.item_group = 'give'
        and a.deleted_at is null
        order by a.created_at desc
    </select>

    <select id="getItemDetail" resultMap="shaItemMap">
        select a.*, b.nickname, b.level, c.eup_myeon_dong_name, d.return_date
        from sha_items a
        inner join member b
        on a.owner_no = b.member_no
        inner join location c
        on a.loc_code = c.location_code
        left join
        (
        select *
        from sha_req
        where status_code = 'RNT'
        and req_item = #{itemNo}
        ) d
        on a.item_no = d.req_item
        where a.item_no = #{itemNo}
    </select>

    <select id="getItemImgs" resultType="attachmentDTO">
        select *
        from attachment
        where target_no = #{itemNo}
        and type_code = #{itemGroup}
    </select>

    <select id="searchItems" resultMap="shaItemMap">
        select a.*, c.saved_name
        from (
        select b.*, e.*, f.eup_myeon_dong_name,
        row_number() over (order by b.created_at desc) as rn
        from sha_items b
        inner join
        location f
        on b.loc_code = f.location_code
        left join member d
        on b.owner_no = d.member_no
        left join
        (
        select req_item, return_date
        from sha_req
        where status_code = 'RNT'
        ) e
        on b.item_no = e.req_item
        where b.deleted_at is null
        and d.is_deleted = 'N'
        <if test="locCode != null and locCode != ''">and b.loc_code = #{locCode}</if>
        <if test="group != null and group != ''">and b.item_group = #{group}</if>
        <if test="catCode != null and catCode != ''">and b.item_cat_code = #{catCode}</if>
        <if test="statusCode != null and statusCode != ''">and b.status_code = #{statusCode}</if>
        <if test="keyword != null and keyword != ''">and (b.title like concat('%', #{keyword}, '%') or b.content like concat('%', #{keyword}, '%')) </if>
        ) a
        left join
        (
        select target_no, saved_name, type_code
        from (
        select *,
        row_number() over (partition by target_no order by file_no) as rn
        from attachment
        ) sub
        where rn = 1
        ) c
        on a.item_no = c.target_no
        and a.item_group = c.type_code
        where a.rn between #{start} and #{end}
        order by a.rn
    </select>

    <select id="getItemCounts" resultType="Integer">
        select count(*)
        from sha_items a
        left join member b
        on a.owner_no = b.member_no
        where a.deleted_at is null
        and b.is_deleted = 'N'
        <if test="locCode != null and locCode != ''">and a.loc_code = #{locCode}</if>
        <if test="group != null and group != ''">and a.item_group = #{group}</if>
        <if test="catCode != null and catCode != ''">and a.item_cat_code = #{catCode}</if>
        <if test="statusCode != null and statusCode != ''">and a.status_code = #{statusCode}</if>
        <if test="keyword != null and keyword != ''">and (a.title like concat('%', #{keyword}, '%') or a.content like concat('%', #{keyword}, '%')) </if>
    </select>

    <insert id="insertRequest">
        insert into sha_req
        <choose>
            <when test="reqGroup == 'rent'">
                (req_item, rqst_no, return_date)
                values
                (#{reqItem}, #{rqstNo}, #{returnDate})
            </when>
            <otherwise>
                (req_item, rqst_no)
                values
                (#{reqItem}, #{rqstNo})
            </otherwise>
        </choose>
    </insert>

    <select id="findRequest" resultType="shaReqDTO">
        select *
        from sha_req
        where req_item = #{reqItem}
        <if test="rqstNo != 0 and rqstNo != ''">
            and rqst_no = #{rqstNo}
        </if>
        <if test="statusCode != null and statusCode != ''">
            and status_code = #{statusCode}
        </if>
    </select>

    <update id="updateItem">
        update sha_items
        set
        item_cat_code = #{itemCatCode},
        title = #{title},
        content = #{content},
        modified_at = now()
        where item_no = #{itemNo}
    </update>

    <delete id="deleteImgList">
        delete
        from attachment
        <foreach collection="list" item="img" separator=",">
            where file_no = #{img.fileNo}
        </foreach>
    </delete>

    <update id="deleteItem">
        update
        sha_items
        set deleted_at = now()
        where item_no = #{itemNo}
    </update>

    <delete id="deleteImgByTarget">
        delete
        from attachment
        where target_no = #{targetNo}
        and type_code = #{typeCode}
    </delete>

    <update id="updateItStat">
        update sha_items
        set
        status_code = #{statusCode},
        modified_at = now()
        where item_no = #{itemNo}
    </update>

    <update id="plusViewCnt">
        update sha_items
        set
        view_cnt = view_cnt + 1
        where item_no = #{itemNo}
    </update>

    <select id="getShaLike" resultType="shaLikeDTO">
        select *
        from sha_like
        where member_no = #{memberNo}
        <if test="itemNo != 0 and itemNo != ''">
            and item_no = #{itemNo}
        </if>
    </select>

    <insert id="insertShaLike">
        insert
        into sha_like
        (member_no, item_no)
        values (#{memberNo}, #{itemNo})
    </insert>

    <delete id="deleteShaLike">
        delete
        from sha_like
        where member_no = #{memberNo}
        and item_no = #{itemNo}
    </delete>

    <update id="plusLikeCnt">
        update sha_items
        set
        like_cnt = like_cnt + 1
        where item_no = #{itemNo}
    </update>

    <update id="minusLikeCnt">
        update sha_items
        set
        like_cnt = like_cnt - 1
        where item_no = #{itemNo}
    </update>

    <update id="plusReqCnt">
        update sha_items
        set
        req_cnt = req_cnt + 1
        where item_no = #{itemNo}
    </update>

    <update id="minusReqCnt">
        update sha_items
        set
        req_cnt = req_cnt - 1
        where item_no = #{itemNo}
    </update>

    <select id="getLendList" resultMap="shaItemMap">
        select a.*, c.saved_name, e.status_name
        from
        (
            select b.*, e.*, d.nickname, f.eup_myeon_dong_name,
            row_number() over (order by b.created_at desc) as rn
            from sha_items b
            left join
            member d
            on b.owner_no = d.member_no
            inner join
            location f
            on b.loc_code = f.location_code
            left join
            (
                select req_item, return_date
                from sha_req
                where status_code = 'RNT'
            ) e
            on b.item_no = e.req_item
            where b.deleted_at is null
            and b.owner_no = #{ownerNo}
            <if test="catCode != null and catCode != ''">and b.item_cat_code = #{catCode}</if>
            <if test="group != null and group != ''">and b.item_group = #{group}</if>
            <if test="statusCode != null and statusCode != ''">and b.status_code = #{statusCode}</if>
            <if test="keyword != null and keyword != ''">and (b.title like concat('%', #{keyword}, '%') or b.content like concat('%', #{keyword}, '%')) </if>
        ) a
        left join
            (
            select target_no, saved_name, type_code
            from
                (
                select *,
                row_number() over (partition by target_no order by file_no) as rn
                from attachment
                ) sub
                where rn = 1
            ) c
        on a.item_no = c.target_no
        and a.item_group = c.type_code
        left join
        sha_status e
        on a.status_code = e.status_code
        where a.rn between #{start} and #{end}
        order by a.rn
    </select>

    <select id="getLendCounts" resultType="Integer">
        select count(*)
        from sha_items
        where deleted_at is null
        and owner_no = #{ownerNo}
        <if test="catCode != null and catCode != ''">and item_cat_code = #{catCode}</if>
        <if test="group != null and group != ''">and item_group = #{group}</if>
        <if test="statusCode != null and statusCode != ''">and status_code = #{statusCode}</if>
        <if test="keyword != null and keyword != ''">and (title like concat('%', #{keyword}, '%') or content like concat('%', #{keyword}, '%')) </if>
    </select>

    <select id="getReqList" resultMap="shaReqMap">
        select a.*, d.*, e.status_name
        from
        (
            *,
            row_number() over (order by b.modified_at desc) as rn
            from
            sha_req
        ) a
        left join
            (
                select
                    b.*, c.saved_name
                from
                    sha_items b
                left join
                    (
                        select target_no, type_code, saved_name
                        from
                        (
                            select *,
                                row_number() over (partition by target_no order by file_no) as rn
                            from attachment
                        ) sub
                    where rn = 1
                    ) c
                on b.item_no = c.target_no and b.item_group = c.type_code
            ) d
        on a.req_item = d.item_no
        left join
            sha_status e
        on a.status_code = e.status_code
        where a.rn between #{start} and #{end}
        order by a.rn
        <if test="catCode != null and catCode != ''">and item_cat_code = #{catCode}</if>
        <if test="group != null and group != ''">and item_group = #{group}</if>
        <if test="reqItem != 0 and reqItem != ''">and a.reqItem = #{reqItem}</if>
        <if test="rqstNo != 0 and rqstNo != ''">and a.rqstNo = #{rqstNo}</if>
        <if test="statusCode != null and statusCode != ''">and a.status_code = #{statusCode}</if>
        <if test="keyword != null and keyword != ''">and (title like concat('%', #{keyword}, '%') or content like concat('%', #{keyword}, '%')) </if>
    </select>

    <select id="getRequesters" resultMap="shaReqMap">
        select a.*, b.nickname, c.item_group
        from sha_req a
        left join
        member b
        on a.rqst_no = b.member_no
        left join sha_items c
        on a.req_item = c.item_no
        where a.req_item = #{reqItem}
        and a.status_code = #{statusCode}
    </select>

    <update id="updateReqStat">
        update
        sha_req
        set
        status_code = #{statusCode},
        return_date = #{returnDate}
        where req_no = #{reqNo}
    </update>

</mapper>
