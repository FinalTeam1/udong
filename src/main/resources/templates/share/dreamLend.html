<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Title</title>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.css">
    <style>
        html {
          scrollbar-gutter: stable;
        }

        .dream .row > div{
            height: 150px;
        }

        .dream {
            border: none !important;
            height: 150px;
            background-color: #F5F5F5;
        }

        .rentGroup{
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #3B5C9A !important;
            color: #FFFFFF;
            text-align: center;
            font-size: 20px;
            font-weight: bolder;
        }

        .giveGroup{
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #FFB83D !important;
            color: #FFFFFF;
            text-align: center;
            font-size: 20px;
            font-weight: bolder;
        }


        .img-area,
        .item-info-area{
            display: flex;
            align-items: center;
            justify-content: center;

        }

        .select-area{
            display: flex;

        }

        .card-body p span{
            margin-right: 1em;
            width: 10em !important;
        }

        .card-body,
        .btn-group{
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .status-area{
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;

        }

        .status-select-area{
            display:flex;
            align-items: center;
            justify-content: flex-end;
            font-size: 16px;

        }

        .catSelect{
            width: 11em !important;
            margin-right: 20px;

        }

        .stat-select{
            width:8em !important;

        }

        .page-link{
            background-color: #3B5C9A !important;
            border-color: #3B5C9A !important;
            color: #FFFFFF !important;
        }

        .pageActive{
            background-color: #0B1D40 !important;
            border-color: #0B1D40 !important;
            color: #FFFFFF !important;
        }

        .page-link:active,
        .page-link:focus{
            background-color: #0B1D40 !important;
            border-color: #0B1D40 !important;
            color: #FFFFFF !important;
        }

        .star_rating {
          width: 100%;
          box-sizing: border-box;
          display: inline-flex;
          float: left;
          flex-direction: row;
          justify-content: center;
        }
        .star_rating .star {
          width: 30px;
          height: 30px;
          margin-right: 10px;
          display: inline-block;
          background: url('/img/emptystar.png') no-repeat;
          background-size: 100%;
          box-sizing: border-box;
        }
        .star_rating .star.on {
          width: 30px;
          height: 30px;
          margin-right: 10px;
          display: inline-block;
          background: url('/img/star.png') no-repeat;
          background-size: 100%;
          box-sizing: border-box;
        }

        .star_box {
          width: 400px;
          box-sizing: border-box;
          display: inline-block;
          margin: 15px 0;
          background: #F3F4F8;
          border: 0;
          border-radius: 10px;
          height: 100px;
          resize: none;
          padding: 15px;
          font-size: 13px;
          font-family: sans-serif;
        }
        .btn02 {
          display:block;
          width: 400px;
          font-weight: bold;
          border: 0;
          border-radius: 10px;
          max-height: 50px;
          padding: 15px 0;
          font-size: 1.1em;
          text-align: center;
          background:bisque;
        }

        .div-blur{
            background-color: black;
            position:relative;
        }

        .img-blur{
            opacity: 0.5;
        }

        .blur-info{
            color:white;
            position:absolute;
            top: 50%;
            left: 50%;
            text-align: center;
            transform: translate(-50%, -50%);
        }

        .level{
            width:20px;
            margin-left: 3px;
        }

        .popover{
            max-width: 350px;
        }

        .popover-header {
            background-color: #FFB83D !important; /* 헤더 배경색 변경 */
            font-weight: 600;
            color: #ffffff !important;
            border-bottom-color: #ffffff !important; /* 헤더 아래쪽 테두리 색상 */
        }

        .popover-body {
            font-size: 15px;

        }

        .dropdown-btns{
            --bs-dropdown-min-width: 5rem !important;
            background-color: #979797 !important;
        }

        .dropdown-item.active,
        .dropdown-item:active{
            background-color: #6A6A6A !important;

        }

        .btn-udh-nocolor,
        .btn-udh-nocolor:focus,
        .btn-udh-nocolor:focus-visible,
        .btn-udh-nocolor:active,
        .btn.show{
            background: none;
            border: none !important;
        }




    </style>
</head>
<body id="dreamLend">
<div th:replace="~{/common/menubar}"></div>
<div th:replace="~{share/dreamMenubar :: #dreamMenubar}"></div>

<div class="container" style="width:80%">
    <h2 class="my-3" style="text-align:center; font-weight:bolder;">나의 빌려(나눠)드림 목록</h2>

    <div class="select-area mb-1 mt-3 ms-1 ">
        <div class="col-3">
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="group" id="inlineRadio1"
                       value="" checked onchange="getLendList()">
                <label class="form-check-label" for="inlineRadio1">모두</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="group" id="inlineRadio2"
                       value="rent" onchange="getLendList()">
                <label class="form-check-label" for="inlineRadio2">대여</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="group" id="inlineRadio3"
                       value="give" onchange="getLendList()">
                <label class="form-check-label" for="inlineRadio3">나눔</label>
            </div>

        </div>

        <div class="status-select-area col-9">
            <select th:fragment="catSelect" id="catSelect" class="form-select catSelect" name="itemCatCode"
                    onchange="getLendList()">
                <option value="">== 카테고리 선택 ==</option>
                <th:block th:if="${catList} != null">
                    <option th:each="cat:${catList}" th:value=${cat.catCode} th:text="${cat.catName}"></option>
                </th:block>
            </select>
            <label for="statusSelect" style="width:2em">
                상태
            </label>
            <select class="form-select stat-select me-3" id=statusSelect name="statusSelect" onchange="getLendList()">
                <option value="">== 전체 ==</option>
                <option value="RNT">대여중</option>
                <option value="AVL">대여가능</option>
                <option value="UNAV">대여불가</option>
                <option value="GIV">나눔중</option>
                <option value="GVD">나눔완료</option>
            </select>

            <input class="form-control me-2" type="search" placeholder="검색어를 입력하세요." id="keyword" style="width:13em">
            <button class="btn btn-udh-blue searchBtn" type="button" onclick="getLendList()">검색</button>

        </div>
    </div>

    <div th:fragment="dreams" id="dreams">
        <th:block th:if="${#lists.isEmpty(lendList)}">
            <div class="alert alert-secondary" role="alert" style="width:100%; text-align:center">
                등록된 물건이 없습니다.
            </div>
        </th:block>
        <th:block th:unless="${#lists.isEmpty(lendList)}">
            <div th:each="item : ${lendList}" class=" mb-3 dream">
                <div th:data-dream-id="dream+${item.itemNo}" id="dream">
                    <div class="row g-0">
                        <div th:classappend="${item.itemGroup == 'rent' ? 'rentGroup' : 'giveGroup'}" class="col-1">
                            [[${item.itemGroup == 'rent' ? '대여' : '나눔'}]]
                        </div>
                        <div th:onclick="|location.href='@{/share/{itemGroup}/detail(itemNo=${item.itemNo}, itemGroup=${item.itemGroup})}'|"
                             class="col-2 img-area"
                             th:classappend="${item.statusCode != 'AVL' && item.statusCode != 'GIV'? ' div-blur' : ''}">
                            <img th:src="${item.img == null ? '/img/noimg.jpg' : '/uploadFiles/' + item.img}"
                                 class="img-fluid " alt="물건이미지" style="height:140px; cursor:pointer;"
                                 th:classappend="${item.statusCode != 'AVL'  && item.statusCode != 'GIV' ? ' img-blur' : ''}">
                        </div>
                        <div class="col-4 item-info-area "
                             th:onclick="|location.href='@{/share/{itemGroup}/detail(itemNo=${item.itemNo}, itemGroup=${item.itemGroup})}'|"
                             style="cursor:pointer;">
                            <div class="card-body p-3">
                            <span class="badge text-bg-secondary mb-1"
                                  style="width:max-content">[[${item.itemCatName}]]</span>
                                <h4 class="mb-3">[[${item.title}]]</h4>
                                <p><span>💛   [[${item.likeCnt}]]</span> <span>👀   [[${item.viewCnt}]]</span>
                                    <span>🙋‍♀️   [[${item.reqCnt}]]</span></p>
                                <p style="margin-bottom: 0">
                                    <span>[[${item.locName}]]</span><span id="modifiedAt">[[${item.displayDate}]]</span>
                                </p>
                            </div>
                        </div>
                        <div class="col-3 col-sm-2 status-area">
                            <h5 class="align-middle" style="margin:0;">[[${item.statusName}]]</h5>
                            <div th:if="${item.statusCode == 'RNT'}" class="align-middle">반납예정일: [[${item.returnDate}]]
                            </div>
                            <div th:if="${item.statusCode == 'GVD'}" class="align-middle">당첨자: [[${item.rqstNickname}]]
                            </div>
                        </div>
                        <div class="col-2 col-sm-3 position-relative">
                            <div th:if="${item.statusCode == 'AVL' || item.statusCode == 'UNAV'}">
                                <div class="dropdown dropend position-absolute top-0 end-0">
                                    <button class="btn btn-udh-nocolor" type="button" data-bs-toggle="dropdown"
                                            aria-expanded="false" style="font-weight:bold; font-size:1.5em;">
                                        &#8230;
                                    </button>
                                    <ul class="dropdown-menu dropdown-btns">
                                        <li>
                                            <button th:onclick="|location.href='@{/share/update(itemNo=${item.itemNo})}'|"
                                                    class="btn btn-udh-silver dropdown-item">수정하기
                                            </button>
                                        </li>
                                        <li>
                                            <button
                                                    class="btn btn-udh-silver dropdown-item"
                                                    th:onclick="toggleDeleteItemModal([[${item}]])">
                                                삭제하기
                                            </button>
                                        </li>
                                        <li>
                                            <button th:text="${item.statusCode == 'AVL' ? '일시중단' : '중단해제'}"
                                                    class="btn btn-udh-silver dropdown-item"
                                                    th:onclick="updateItStat([[${item}]])"></button>
                                        </li>
                                    </ul>
                                </div>
                                <div class="position-absolute top-50 start-50 translate-middle-y">
                                    <button class="btn btn-udh-blue"
                                            th:onclick="selectReq([[${item.itemNo}]])">대여확정
                                    </button>
                                </div>

                            </div>

                            <div th:if="${item.statusCode == 'RNT'}">
                                <div class="dropdown dropend position-absolute top-0 end-0">
                                    <button class="btn btn-udh-nocolor" type="button" data-bs-toggle="dropdown"
                                            aria-expanded="false" style="font-weight:bold; font-size:1.5em;">
                                        &#8230;
                                    </button>
                                    <ul class="dropdown-menu dropdown-btns">
                                        <li>
                                            <button th:onclick="|location.href='@{/share/update(itemNo=${item.itemNo})}'|"
                                                    class="btn btn-udh-silver dropdown-item">
                                                수정하기
                                            </button>
                                        </li>
                                        <li>
                                            <button class="btn btn-udh-red dropdown-item"
                                                    th:onclick="toggleReportModalLend([[${item}]])">신고하기
                                            </button>
                                        </li>
                                        <li>
                                            <button class="btn btn-udh-yellow dropdown-item"
                                                    th:onclick="sendMsg([[${item.rqstNo}]])">쪽지하기
                                            </button>
                                        </li>
                                    </ul>
                                </div>

                                <div class="position-absolute top-50 start-50 translate-middle-y">
                                    <button class="btn btn-udh-blue"
                                            th:onclick="evalWithReturnReq([[${item}]])">반납완료
                                    </button>
                                </div>

                            </div>
                            <div th:if="${item.statusCode == 'GVD'}">
                                <div class="position-absolute top-50 start-50 translate-middle-y">
                                    <button th:onclick="sendMsg([[${item.rqstNo}]])" class="btn btn-udh-yellow "
                                            style="width:max-content">쪽지하기
                                    </button>

                                </div>
                            </div>

                        </div>
                    </div>
                </div>

            </div>

        </th:block>


        <nav class="row mt-3" th:if="${pageInfo} != null">
            <ul th:if="${pageInfo.totalCounts > 0}" class="pagination pagination-sm justify-content-center ">
                <li class="page-item me-1" th:style="${pageInfo.currentPage == 1 ? 'visibility:hidden' : ''}">
                    <button th:onclick="getLendList([[${pageInfo.currentPage-1}]])" class="page-link btn-udh-blue "
                            aria-label="Previous" style="caret-color: transparent;">
                        <span>&laquo;</span>
                    </button>
                </li>
                <li th:each="page : ${#numbers.sequence(pageInfo.startPage, pageInfo.endPage)}"
                    class="page-item active me-1" aria-current="page">
                    <button th:text="${page}" class="page-link btn-udh-blue"
                            th:onclick="getLendList([[${page}]])"
                            th:classappend="${pageInfo.currentPage == page ? 'pageActive' : ''}"
                            style="caret-color: transparent;"></button>
                </li>
                <li th:style="${pageInfo.currentPage == pageInfo.totalPage ? 'visibility:hidden' : ''}"
                    class="page-item me-1">
                    <button class="page-link btn-udh-blue " aria-label="Previous"
                            th:onclick="getLendList([[${pageInfo.currentPage+1}]])" style="caret-color: transparent;">
                        <span>&raquo;</span>
                    </button>
                </li>
            </ul>
        </nav>

    </div>

    <div id="dreamModals">
        <div class="modal fade" id="selectRqst" aria-hidden="true" aria-labelledby="selectRqstLabel" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header " style="background-color: #3B5C9A;
                         color: #FFFFFF;">
                        <h1 class="modal-title fs-5" id="selectRqstLabel">대여를 확정할 이웃을 선택해주세요.</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="dateRefresh()"></button>
                    </div>
                    <div class="modal-body">
                        <th:block th:if="${#lists.isEmpty(requesters)}">
                            <div>
                                대여를 신청한 이웃이 없습니다.
                            </div>
                        </th:block>
                        <th:block th:unless="${#lists.isEmpty(requesters)}">
                            <div style="font-size:0.9em; margin-bottom:5px;">&#128070;신청자 닉네임에 커서를 올리면 신청자 대여 정보를 확인할 수
                                있습니다.
                            </div>
                            <table class="table table-warning table-hover table-bordered text-center ">
                                <thead>
                                <tr class="">
                                    <th scope="col">체크</th>
                                    <th scope="col">대여신청자</th>
                                    <th scope="col">신청일시</th>
                                    <th scope="col">반납희망일</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="rqst, stat : ${requesters}">
                                    <th class="align-middle" scope="row">
                                        <input class="align-middle" type="radio" name="requesters"
                                               th:value="${rqst.rqstNo}"
                                               th:checked="${stat.first ? 'true' : 'false'}">
                                    </th>
                                    <td class="align-middle"><a tabindex="0" class="" role="button"
                                                                data-bs-toggle="popover"
                                                                data-bs-html="true"
                                                                data-bs-trigger="hover focus"
                                                                th:data-bs-title="${rqst.rqstNickname}+'님의 대여 기록'"
                                                                th:data-bs-content="'&#128202;총 대여 횟수: '+${rqst.endReqCnt}+'<br/> &#127775;평균 별점: '+${#numbers.formatDecimal(rqst.avgRating, 1, 2)}+'<br/> &#127894;레벨: '+${rqst.rqstLevel}"><img
                                            style="width:25px; height:25px; margin-right:7px"
                                            th:src="${rqst.rqstImg == null ? '/img/defaultProfile.png' : '/uploadFiles/' + rqst.rqstImg}"
                                            class="user-icon">[[${rqst.rqstNickname}]]<img class="level"
                                                                                           th:src="@{'/img/'+${rqst.rqstLevel}+'.png'}"></a>
                                    </td>
                                    <td class="align-middle">[[${#temporals.format(rqst.reqCreatedAt, 'yyyy.MM.dd
                                        HH:mm')}]]
                                    </td>
                                    <td class="align-middle">[[${rqst.returnDate}]]</td>
                                </tr>
                                </tbody>
                            </table>

                        </th:block>
                    </div>
                    <div class="modal-footer">
                        <th:block th:if="${#lists.isEmpty(requesters)}">
                            <button class="btn btn-udh-blue" data-bs-target="#selectRqst" data-bs-dismiss="modal">
                                확인
                            </button>
                        </th:block>
                        <th:block th:unless="${#lists.isEmpty(requesters)}">
                            <button class="btn btn-udh-silver" data-bs-target="#selectRqst" data-bs-dismiss="modal" onclick="dateRefresh()">
                                취소
                            </button>
                            <button class="btn btn-udh-blue" th:onclick="checkReturnDate([[${requesters}]])"
                                    id="checkDateBtn">다음
                            </button>
                        </th:block>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="approveReq" aria-hidden="true" aria-labelledby="approveReqLabel" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header" style="background-color: #3B5C9A;
                         color: #FFFFFF;">
                        <h1 class="modal-title fs-5" id="approveReqLabel">반납예정일을 확인해주세요.</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="dateRefresh()"></button>
                    </div>
                    <div class="modal-body">
                        <label class="form-label">📅반납희망일 확인</label>

                        <div class="input-group input-daterange">
                            <input type="date" class="form-control" name="return" id="datePicker" readonly>
                        </div>
                        <span style="font-size:0.7em">*반납예정일을 확정해주세요..</span>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-udh-silver" id="backToSelectReq" onclick="dateRefresh()">이전
                        </button>
                        <button class="btn btn-udh-blue" id="approveBtn">확정</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="evalAndReportModal">
        <div class="modal fade" id="evalModal" tabindex="-1" aria-labelledby="evalModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header" style="background-color: #3B5C9A;
                         color: #FFFFFF;">
                        <h1 class="modal-title fs-5" id="evalModalLabel">이웃 평가 후 '반납완료' 처리가 가능합니다. </h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div th:if="${req != null && req != ''}" class="modal-body text-center">
                        [[${req.rqstNickname}]]님의 매너를 평가해 주세요.


                        <div class="star_rating mt-3">
                            <input type="hidden" id="score" value="5">
                            <span class="star on" data-value="1"> </span>
                            <span class="star on" data-value="2"> </span>
                            <span class="star on" data-value="3"> </span>
                            <span class="star on" data-value="4"> </span>
                            <span class="star on" data-value="5"> </span>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                        <button type="button" class="btn btn-primary" th:onclick="postScore([[${req}]])">확인</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel"
             aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header "
                         style="background-color:#CB3333; color:white; background-image : var (-bs-gradient);">
                        <h1 class="modal-title fs-5" id="reportModalLabel">신고하기</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <th:block th:if="${req != null}">
                            <form id="reportForm">
                                <div class="mb-3 row">
                                    <label for="itemTitle" class="col-sm-2 col-form-label">물건:</label>
                                    <div class="col-sm-10">
                                        <input type="text" readonly class="form-control-plaintext" id="itemTitle"
                                               th:value="${req.itemDTO.title}">
                                        <input type="hidden" name="reportedNo" th:value="${req.reqNo}">
                                        <input type="hidden" name="typeCode" th:value="${req.itemDTO.itemGroup}">
                                        <input type="hidden" name="itemNo" th:value="${req.reqItem}">
                                    </div>


                                </div>
                                <div class="mb-3 row">
                                    <label for="reporterMember" class="col-sm-2 col-form-label">신고인:</label>
                                    <div class="col-sm-10">
                                        <input type="text" readonly class="form-control-plaintext"
                                               id="reporterMember" th:value="${req.ownerNickname}">
                                        <input type="hidden" name="reporterMember" th:value="${req.itemDTO.ownerNo}">
                                    </div>
                                </div>
                                <div class="mb-3 row">
                                    <label for="reportedMember" class="col-sm-2 col-form-label">신고대상:</label>
                                    <div class="col-sm-10">
                                        <input type="text" class="form-control-plaintext"
                                               id="reportedMember"
                                               readonly th:value="${req.rqstNickname}">
                                        <input type="hidden" name="reportedMember" th:value="${req.rqstNo}">
                                    </div>
                                </div>
                                <div class="mb-3 row">
                                    <label for="reasonDetail" class="col-sm-2 col-form-label">신고내용:</label>
                                    <div class="col-sm-10 p-2">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="reasonType"
                                                   id="exampleRadios1" value="미반납" checked>
                                            <label class="form-check-label" for="exampleRadios1">
                                                물건을 돌려받지 못했어요.
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="reasonType"
                                                   id="exampleRadios2" value="반납물건이상">
                                            <label class="form-check-label" for="exampleRadios2">
                                                돌려받은 물건의 상태가 이상해요.
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="reasonType"
                                                   id="exampleRadios3" value="기타">
                                            <label class="form-check-label" for="exampleRadios3">
                                                기타
                                            </label>
                                        </div>
                                        <textarea name="reasonDetail" class="form-control" id="reasonDetail" rows="3"
                                                  placeholder="이웃과 나눈 쪽지 내용이나 물건의 상태 등을 적어주세요."></textarea>
                                    </div>

                                </div>
                            </form>
                        </th:block>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-udh-silver" data-bs-dismiss="modal">취소</button>
                        <button type="button" class="btn btn-udh-red" id="reportBtn" onclick="postReport()">신고</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.js"></script>
<script type="text/javascript" th:src="@{/js/sha.js}"></script>
</body>
</html>